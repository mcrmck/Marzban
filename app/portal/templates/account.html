{% extends "base.html" %}

{% block title %}My Account - VPN Portal{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h2 class="text-2xl font-bold mb-6 text-gray-900">Account Overview</h2>

    {# Existing alert messages for payment status #}
    {% if request.query_params.get('payment_status') == 'mock_success' %}
    <div class="p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg" role="alert">
        Mock payment successful! Your account should now be active.
    </div>
    {% elif request.query_params.get('payment_status') == 'success' %}
    <div class="p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg" role="alert">
        Payment successful! Your account is now active.
    </div>
    {% elif request.query_params.get('payment_status') == 'cancelled' %}
    <div class="p-4 mb-4 text-sm text-yellow-700 bg-yellow-100 rounded-lg" role="alert">
        Payment was cancelled. Your account is not yet active.
    </div>
    {% elif request.query_params.get('payment_status') == 'mock_failure' %}
    <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
        Mock payment simulation failed. Please check server logs.
    </div>
    {% endif %}

    {# Existing account information display #}
    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-6">
        <p class="mb-2 text-gray-700"><strong>Account Number:</strong> {{ current_user.account_number }}
            <button onclick="copyToClipboard('{{ current_user.account_number }}', event)" class="ml-2 p-1 text-xs bg-gray-200 hover:bg-gray-300 rounded" aria-label="Copy account number">Copy</button>
        </p>
        <p class="mb-4 text-gray-700"><strong>Status:</strong>
            <span class="font-semibold
                {% if current_user.status == UserStatus.active %}text-green-600
                {% elif current_user.status == UserStatus.disabled %}text-red-600
                {% elif current_user.status == UserStatus.expired %}text-yellow-600
                {% elif current_user.status == UserStatus.limited %}text-orange-600
                {% elif current_user.status == UserStatus.on_hold %}text-blue-600
                {% else %}text-gray-600{% endif %}">
                {{ current_user.status.value | capitalize }}
            </span>
        </p>

        {% if current_user.status == UserStatus.active %}
            <p class="mb-2 text-gray-700"><strong>Data Limit:</strong> {{ current_user.data_limit | readable_bytes }}</p>
            <p class="mb-2 text-gray-700"><strong>Data Usage:</strong> {{ current_user.used_traffic | readable_bytes }}</p>
            <p class="mb-4 text-gray-700"><strong>Expires:</strong>
                {% if current_user.expire %}
                    {{ current_user.expire | timestamp_to_datetime_str }}
                    ({{ current_user.expire | time_until_expiry }})
                {% else %}
                    Never
                {% endif %}
            </p>
        {% elif current_user.status == UserStatus.disabled %}
            <p class="text-red-600 mb-4">Your account is currently inactive. Please select a plan below to activate your service.</p>
        {% elif current_user.status == UserStatus.expired %}
             <p class="text-yellow-700 mb-4">Your plan has expired. Please choose a new plan to continue service.</p>
        {% elif current_user.status == UserStatus.limited %}
             <p class="text-orange-600 mb-4">Your account has reached its data limit. Please wait for reset or consider upgrading.</p>
        {% endif %}
    </div>

    {# Existing plans display if user is not active #}
    {% if current_user.status != UserStatus.active %}
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-900">
                {% if current_user.status == UserStatus.disabled %}Activate Your Account{% elif current_user.status == UserStatus.expired %}Renew Your Plan{% else %}Choose a Plan{% endif %}
            </h3>
            {% if plans %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for plan in plans %}
                <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
                    <div class="p-6 flex-grow">
                        <h4 class="text-xl font-bold text-gray-900 mb-2">{{ plan.name }}</h4>
                        <p class="text-gray-600 text-sm mb-4">{{ plan.description }}</p>
                        <div class="text-2xl font-bold text-gray-900 mb-4">
                            ${{ "%.2f"|format(plan.price) }}<span class="text-base font-normal text-gray-600">/{{ plan.duration_days }} days</span>
                        </div>
                        <ul class="space-y-2 mb-6 text-sm text-gray-600">
                            {% for feature in plan.features %}
                            <li class="flex items-center">
                                <svg class="h-4 w-4 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                {{ feature }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="p-6 bg-gray-50">
                        <button
                            onclick="selectPlan('{{ plan.id }}')"
                            class="w-full bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                        >
                            Select Plan
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-600">No plans are currently available. Please check back later.</p>
            {% endif %}
        </div>
    {% endif %}

    {# Modified Subscription & Configs section for active users #}
    {% if current_user.status == UserStatus.active %}
        <div class="mb-8 bg-white shadow-md rounded px-8 pt-6 pb-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-900">Your Subscription & Configs</h3>

            {% if not current_user.active_node_id %}
            <div class="p-4 mb-4 text-sm text-blue-700 bg-blue-100 rounded-lg" role="alert">
                Your account is active! Please visit the <a href="{{ url_for('portal_servers_page') }}" class="font-medium underline">Servers</a> page to choose and activate a server to get your configuration links.
            </div>
            {% endif %}

            {# Client-specific profile download links #}
            <p class="mb-2 text-gray-700">Client-specific profile download links:</p>
            <ul class="list-disc pl-5 space-y-1 text-sm mb-6">
                {% set sub_base = subscription_url_base %}
                <li><span class="font-medium text-gray-800">Clash:</span> <a href="{{ sub_base }}/clash" class="text-blue-600 hover:underline break-all" target="_blank">{{ sub_base }}/clash</a> <button onclick="copyToClipboard('{{ sub_base }}/clash', event)" class="ml-2 p-1 text-xs bg-gray-200 hover:bg-gray-300 rounded" aria-label="Copy Clash link">Copy</button></li>
                <li><span class="font-medium text-gray-800">Clash Meta:</span> <a href="{{ sub_base }}/clash-meta" class="text-blue-600 hover:underline break-all" target="_blank">{{ sub_base }}/clash-meta</a> <button onclick="copyToClipboard('{{ sub_base }}/clash-meta', event)" class="ml-2 p-1 text-xs bg-gray-200 hover:bg-gray-300 rounded" aria-label="Copy Clash Meta link">Copy</button></li>
                <li><span class="font-medium text-gray-800">Sing-box:</span> <a href="{{ sub_base }}/sing-box" class="text-blue-600 hover:underline break-all" target="_blank">{{ sub_base }}/sing-box</a> <button onclick="copyToClipboard('{{ sub_base }}/sing-box', event)" class="ml-2 p-1 text-xs bg-gray-200 hover:bg-gray-300 rounded" aria-label="Copy Sing-box link">Copy</button></li>
                <li><span class="font-medium text-gray-800">V2Ray (Share Links):</span> <a href="{{ sub_base }}/v2ray" class="text-blue-600 hover:underline break-all" target="_blank">{{ sub_base }}/v2ray</a> <button onclick="copyToClipboard('{{ sub_base }}/v2ray', event)" class="ml-2 p-1 text-xs bg-gray-200 hover:bg-gray-300 rounded" aria-label="Copy V2Ray share links">Copy</button></li>
                <li><span class="font-medium text-gray-800">V2Ray (Full JSON):</span> <a href="{{ sub_base }}/v2ray-json" class="text-blue-600 hover:underline break-all" target="_blank">{{ sub_base }}/v2ray-json</a> <button onclick="copyToClipboard('{{ sub_base }}/v2ray-json', event)" class="ml-2 p-1 text-xs bg-gray-200 hover:bg-gray-300 rounded" aria-label="Copy V2Ray JSON link">Copy</button></li>
                <li><span class="font-medium text-gray-800">Outline:</span> <a href="{{ sub_base }}/outline" class="text-blue-600 hover:underline break-all" target="_blank">{{ sub_base }}/outline</a> <button onclick="copyToClipboard('{{ sub_base }}/outline', event)" class="ml-2 p-1 text-xs bg-gray-200 hover:bg-gray-300 rounded" aria-label="Copy Outline link">Copy</button></li>
            </ul>

            {# NEW: Individual Server Configuration Links (Vmess, VLESS, etc.) #}
            {% if current_user.links %}
            <h4 class="text-md font-semibold text-gray-800 mb-3 mt-4">Individual Server Configuration Links:</h4>
            <div class="space-y-3">
                {% for link in current_user.links %}
                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-3 p-3 bg-gray-50 rounded-lg">
                    <input type="text" value="{{ link }}" readonly
                           class="w-full sm:flex-1 bg-transparent border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm text-gray-700">
                    <div class="flex space-x-2 flex-shrink-0">
                        <button onclick="copyToClipboard('{{ link }}', event)"
                                class="px-3 py-1.5 rounded-md text-xs font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors duration-200"
                                aria-label="Copy configuration link">
                            Copy
                        </button>
                        <button onclick="showQR('{{ link }}')"
                                class="px-3 py-1.5 rounded-md text-xs font-medium bg-green-100 text-green-700 hover:bg-green-200 transition-colors duration-200"
                                aria-label="Show QR code for configuration link">
                            QR Code
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% elif current_user.active_node_id %}
            <p class="text-gray-600 text-sm">No individual server configuration links available. Please contact support if this persists.</p>
            {% endif %}
        </div>

        {# Existing Available Servers display #}
        <div class="mb-8 bg-white shadow-md rounded px-8 pt-6 pb-8">
             <h3 class="text-xl font-semibold mb-4 text-gray-900">Available Servers</h3>
             {% if nodes %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for node in nodes %}
                    <div class="bg-gray-100 p-4 rounded shadow">
                        <p class="font-semibold text-gray-800">{{ node.name }}</p>
                        <p class="text-sm text-gray-600"><strong>Address:</strong> {{ node.address }}</p>
                        <p class="text-sm text-gray-600"><strong>Status:</strong> <span class="font-medium
                            {% if node.status.value == 'connected' %}text-green-500
                            {% elif node.status.value == 'connecting' %}text-blue-500
                            {% elif node.status.value == 'error' %}text-red-500
                            {% elif node.status.value == 'disabled' %}text-gray-500
                            {% else %}text-yellow-500{% endif %}">
                            {{ node.status.value | capitalize }}
                        </span></p>
                        {% if node.message %}<p class="text-xs text-gray-500 mt-1"><em>{{ node.message }}</em></p>{% endif %}
                    </div>
                    {% endfor %}
                </div>
             {% else %}
                <p class="text-gray-600">No server information available at the moment.</p>
             {% endif %}
        </div>
    {% endif %}
</div>

{# NEW: QR Code Modal (structure adapted from modern.html) #}
<div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-xs w-full mx-4 shadow-xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Scan QR Code</h3>
            <button onclick="hideQR()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="qrCodeContainer" class="flex justify-center"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
{# Add QRCode.js library #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    // Existing Stripe and MOCK_STRIPE_PAYMENT related JS
    const MOCK_STRIPE_PAYMENT_RENDERED_STR = "{{ 'true' if MOCK_STRIPE_PAYMENT else 'false' }}";
    const MOCK_STRIPE_PAYMENT = MOCK_STRIPE_PAYMENT_RENDERED_STR === 'true';
    const STRIPE_PUBLIC_KEY = "{{ STRIPE_PUBLIC_KEY or '' }}";
    console.log("STRIPE_PUBLIC_KEY (JS): ", STRIPE_PUBLIC_KEY);
    console.log("MOCK_STRIPE_PAYMENT (JS): ", MOCK_STRIPE_PAYMENT);

    let stripe;
    if (!MOCK_STRIPE_PAYMENT && STRIPE_PUBLIC_KEY && STRIPE_PUBLIC_KEY !== 'None' && STRIPE_PUBLIC_KEY !== '') {
        try {
            stripe = Stripe(STRIPE_PUBLIC_KEY);
        } catch (e) {
            console.error("Error initializing Stripe:", e);
        }
    } else if (!MOCK_STRIPE_PAYMENT && (!STRIPE_PUBLIC_KEY || STRIPE_PUBLIC_KEY === 'None' || STRIPE_PUBLIC_KEY === '')) {
        console.warn("Stripe public key is not available. Real payment functionality will be disabled.");
    }

    async function selectPlan(planId) {
        if (!MOCK_STRIPE_PAYMENT && (!stripe || !STRIPE_PUBLIC_KEY || STRIPE_PUBLIC_KEY === 'None' || STRIPE_PUBLIC_KEY === '')) {
             alert('Payment system configuration error or Stripe failed to load. Please try again later.');
             console.error('Aborting selectPlan: Mock payment is false, but Stripe key is missing or Stripe object not initialized.');
             return;
        }
        try {
            const response = await fetch("{{ url_for('create_checkout_session') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plan_id: planId }),
                credentials: 'include'
            });
            const session = await response.json();
            if (response.ok && session.url) {
                window.location.href = session.url;
            } else {
                 console.error("Checkout session error response from server:", session);
                 alert('Error: ' + (session.detail || session.error || 'Could not initiate payment. Status: ' + response.status));
            }
        } catch (error) {
            console.error('Error selecting plan (fetch failed):', error);
            alert('An error occurred while trying to initiate payment (network or fetch error). Please try again.');
        }
    }

    // Modified copyToClipboard to accept event argument
    function copyToClipboard(text, event) {
        const buttonElement = event ? event.target : null;
        const originalButtonText = buttonElement ? buttonElement.innerText : 'Copy';

        if (!navigator.clipboard) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; // Prevent scrolling to bottom
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                if (buttonElement) {
                    buttonElement.innerText = 'Copied!';
                    setTimeout(() => { buttonElement.innerText = originalButtonText; }, 1500);
                }
            } catch (err) {
                alert('Failed to copy (fallback). Please copy it manually.');
            }
            return;
        }
        navigator.clipboard.writeText(text).then(function() {
            if (buttonElement) {
                buttonElement.innerText = 'Copied!';
                setTimeout(() => { buttonElement.innerText = originalButtonText; }, 1500);
            }
        }, function(err) {
            alert('Failed to copy. Please copy it manually.');
            console.error('Could not copy text: ', err);
        });
    }

    // NEW: QR Code JavaScript functions (adapted from modern.html)
    function showQR(link) {
        const modal = document.getElementById('qrModal');
        const qrContainer = document.getElementById('qrCodeContainer'); // Corrected ID
        if (modal && qrContainer) {
            modal.classList.remove('hidden');
            // Clear previous QR code
            qrContainer.innerHTML = '';
            // Generate new QR code
            new QRCode(qrContainer, {
                text: link,
                width: 200, // Adjusted size for the modal
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });
        }
    }

    function hideQR() {
        const modal = document.getElementById('qrModal');
        if (modal) {
            modal.classList.add('hidden');
            const qrContainer = document.getElementById('qrCodeContainer'); // Corrected ID
            if (qrContainer) {
                qrContainer.innerHTML = ''; // Clear QR code when hiding
            }
        }
    }
</script>
{% endblock %}