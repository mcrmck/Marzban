{% extends "base.html" %}

{% block title %}Select Server{% endblock %}

{% block head_extra %}
<style>
    .server-list {
        list-style-type: none;
        padding: 0;
    }
    .server-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border: 1px solid #ddd;
        margin-bottom: 10px;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    .server-item.active {
        border-left: 5px solid #28a745; /* Green border for active server */
        background-color: #e9f5ec;
    }
    .server-name {
        font-size: 1.2em;
        font-weight: bold;
    }
    .server-status {
        font-style: italic;
        color: #28a745;
    }
    .activate-btn {
        padding: 8px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }
    .activate-btn:hover {
        background-color: #0056b3;
    }
    .activate-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    .message-box {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    .message-box.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .message-box.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Select Your Active Server</h2>
    <p>Choose a server to activate for your VPN connection. Only one server can be active at a time. Your subscription configuration will reflect the currently active server.</p>

    <div id="alert-message-container"></div>

    {% if nodes %}
        <ul class="server-list">
            {% for node in nodes %}
            <li class="server-item {% if current_user and node.id == current_user.active_node_id %}active{% endif %}">
                <div>
                    <span class="server-name">{{ node.name }}</span>
                    {% if current_user and node.id == current_user.active_node_id %}
                        <span class="server-status ml-2">(Currently Active)</span>
                    {% endif %}
                    <br>
                    <small class="text-muted">Status: {{ node.status.value | title }}</small>
                     </div>
                <div>
                    {% if current_user and node.id == current_user.active_node_id %}
                        <button class="activate-btn" disabled>Active</button>
                    {% elif node.status.value == 'connected' %} {# Only allow activating connected nodes #}
                        <button class="activate-btn"
                                id="activate-btn-{{ node.id }}"
                                onclick="activateNode({{ node.id }}, '{{ current_user.account_number }}')">
                            Activate
                        </button>
                    {% else %}
                         <button class="activate-btn" disabled title="Node is not available">Unavailable</button>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No servers are currently available. Please check back later or contact support.</p>
    {% endif %}
</div>

<script>
    function displayMessage(message, type) {
        const container = document.getElementById('alert-message-container');
        const alertDiv = document.createElement('div');
        alertDiv.className = `message-box ${type}`;
        alertDiv.textContent = message;
        container.innerHTML = ''; // Clear previous messages
        container.appendChild(alertDiv);
        setTimeout(() => {
            if (container.contains(alertDiv)) {
                container.removeChild(alertDiv);
            }
        }, 5000); // Message disappears after 5 seconds
    }

    async function activateNode(nodeId, userAccountNumber) {
        const activateButton = document.getElementById(`activate-btn-${nodeId}`);
        if (!activateButton) return;

        const originalButtonText = activateButton.innerText;
        activateButton.disabled = true;
        activateButton.innerText = 'Activating...';

        // Clear previous messages
        document.getElementById('alert-message-container').innerHTML = '';

        try {
            const response = await fetch(`/api/user/${userAccountNumber}/node/activate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // If your portal login sets up a cookie that FastAPI recognizes for auth,
                    // then no explicit Authorization header might be needed from JS.
                    // Otherwise, you might need to include an Authorization: Bearer <token> header
                    // if the JS can access such a token.
                },
                body: JSON.stringify({ node_id: nodeId })
            });

            // Try to parse JSON regardless of response.ok for error details
            let result;
            try {
                result = await response.json();
            } catch (e) {
                result = { detail: `Failed to parse server response. Status: ${response.status}` };
            }

            if (response.ok) {
                displayMessage(`Node activation for '${nodeId}' initiated! Page will refresh to reflect changes.`, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000); // Reload after a short delay to show message
            } else {
                const errorMessage = result.detail || `Error activating node. Status: ${response.status}`;
                displayMessage(errorMessage, 'error');
                activateButton.innerText = originalButtonText;
                activateButton.disabled = false;
            }
        } catch (error) {
            console.error('Activation request failed:', error);
            displayMessage('Activation request failed due to a network or unexpected error. Please try again.', 'error');
            activateButton.innerText = originalButtonText;
            activateButton.disabled = false;
        }
    }
</script>
{% endblock %}